import os
import logging
import google.cloud.logging
from dotenv import load_dotenv

from google.adk import Agent
from google.adk.agents import SequentialAgent
from google.adk.tools.mcp_tool.mcp_toolset import MCPToolset, StreamableHTTPConnectionParams
from google.adk.tools.tool_context import ToolContext
from google.adk.tools.langchain_tool import LangchainTool

import google.auth
import google.auth.transport.requests
import google.oauth2.id_token

# --- Setup Logging and Environment ---

cloud_logging_client = google.cloud.logging.Client()
cloud_logging_client.setup_logging()

load_dotenv()

model_name = os.getenv("MODEL")

# Greet user and save their prompt

def add_prompt_to_state(
    tool_context: ToolContext, prompt: str
) -> dict[str, str]:
    """Saves the user's initial prompt to the state."""
    tool_context.state["PROMPT"] = prompt
    logging.info(f"[State updated] Added to PROMPT: {prompt}")
    return {"status": "success"}


# Configuring the MCP Tool to connect to the Zoo MCP server

mcp_server_url = os.getenv("MCP_SERVER_URL")
if not mcp_server_url:
    raise ValueError("The environment variable MCP_SERVER_URL is not set.")

def get_id_token():
    """Get an ID token to authenticate with the MCP server."""
    try:
        target_url = os.getenv("MCP_SERVER_URL")
        audience = target_url.split('/mcp/')[0] if '/mcp/' in target_url else target_url
        logging.info(f"Fetching ID token for audience: {audience}")
        request = google.auth.transport.requests.Request()
        id_token = google.oauth2.id_token.fetch_id_token(request, audience)
        logging.info("ID token fetched successfully")
        return id_token
    except Exception as e:
        logging.error(f"Failed to get ID token: {type(e).__name__}: {e}")
        logging.error("Please ensure you have run 'gcloud auth application-default login' or set GOOGLE_APPLICATION_CREDENTIALS")
        raise

mcp_tools = MCPToolset(
            connection_params=StreamableHTTPConnectionParams(
                url=mcp_server_url,
                headers={
                    "Authorization": f"Bearer {get_id_token()}",
                },
            ),
        )


####AGENT SYSTEM PROMPT####

# 1. Researcher Agent
query_agent = Agent(
    name="database_query_agent",
    model=model_name,
    description="The primary database query agent in charge of investigating information in the database",
    instruction="""
    You are a helpful query assistant. Your goal is to fully answer the user's PROMPT.
    You have access to one tool:
    1. A tool for getting data from the main database.

    First, analyze the user's PROMPT.
    - If based on your tool you can fetch some information that may help the user with their query you should go ahead and get information. 

    PROMPT:
    {{ PROMPT }}
    """,
    tools=[
        mcp_tools
    ],
    output_key="fetched_data" # A key to store the combined findings
)

# 2. Response Formatter Agent
response_formatter = Agent(
    name="response_formatter",
    model=model_name,
    description="Synthesizes all information into a friendly, readable response.",
    instruction="""
    You are the friendly voice of the resource allocation project. Your task is to take the
    FETCHED_DATA and present it to the user in a complete and helpful answer.

    - First, present the specific information from the data fetched
    - Then, add the interesting general facts from the data, for example: 
        - resources with most qualifications that could be wildcards for resource allocation. 
        - specific objects must have the ID included for easy tracking
        - metrics or interesting data that may help the user address their issue faster. 

    FETCHED_DATA:
    {{ fetched_data }}
    """
)

database_query_workflow = SequentialAgent(
    name="query_workflow",
    description="The main workflow for handling a user's request about internal data",
    sub_agents=[
        query_agent, # Step 1: Gather all data
        response_formatter,       # Step 2: Format the final response
    ]
)

root_agent = Agent(
    name="greeter",
    model=model_name,
    description="The main entry point for the CFF agent",
    instruction="""
    - Let the user know you are under development and that you can help them learn about the database. 
    - When the user responds, use the 'add_prompt_to_state' tool to save their response.
    After using the tool, transfer control to the 'database_query_workflow' agent.
    """,
    tools=[add_prompt_to_state],
    sub_agents=[database_query_workflow]
)