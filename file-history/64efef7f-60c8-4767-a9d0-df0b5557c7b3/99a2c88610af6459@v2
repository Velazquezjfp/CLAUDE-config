"""
Test script for LC_03 analyzer
"""
import json
from datetime import datetime, timedelta

from analysis.constraint_analyzers.lc_03_analyzer import LC_03_Analyzer
from preprocessing.constraints import ConstraintValues


class MockSolution:
    def __init__(self):
        self.assignments = [{
            'resource_id': 'RES-INT-0003',
            'request_id': 'REQ-828796-41',
            'start': '2024-11-18T08:00:00',
            'end': '2024-11-18T20:00:00',  # 12 hours
            'duration_hours': 12.0
        }]


class MockData:
    def __init__(self):
        self.request_ids = ['REQ-828796-41', 'REQ-828796-42']
        self.resource_ids = ['RES-INT-0003', 'RES-INT-0004']

        # Create mock days
        start_date = datetime(2024, 11, 18, 0, 0)
        self.days = []
        for i in range(7):  # 7 days
            day_start = start_date + timedelta(days=i)
            day_end = day_start + timedelta(days=1)
            self.days.append({
                'start': day_start,
                'end': day_end,
                'date': day_start.date()
            })

    def get_task_hours_in_day(self, request_id, day_idx):
        # Mock: return 12 hours for first day, 0 for others
        if day_idx == 0 and request_id == 'REQ-828796-41':
            return 12.0
        return 0.0


def test_lc03_analyzer():
    print("=" * 60)
    print("TESTING LC_03 ANALYZER")
    print("=" * 60)

    print("\n1. Initializing components...")
    constraints = ConstraintValues(planning_mode="Balanced")
    constraints.legal['max_hours_per_day'] = 12.5
    constraints.company['max_hours_per_day'] = 10.0

    solution = MockSolution()
    data = MockData()

    print(f"   Loaded {len(solution.assignments)} assignments")
    print(f"   Created mock data with {len(data.days)} days")

    # Create mock violation metadata
    print("\n2. Creating mock violation metadata...")
    violation_metadata = [
        {
            'constraint_id': 'LC_03',
            'constraint_name': 'max_absolute_daily_hours',
            'violation_var_name': 'violation_daily_RES-INT-0003_d0',
            'resource_id': 'RES-INT-0003',
            'day_idx': 0,
            'day': data.days[0],
            'legal_limit': 12.5,
            'company_limit': 10.0,
            'assignments_in_day': ['REQ-828796-41']
        }
    ]
    print(f"   Created {len(violation_metadata)} mock violations")

    print("\n3. Running LC_03 analyzer...")
    analyzer = LC_03_Analyzer()
    result = analyzer.analyze_violations(solution, data, constraints, violation_metadata)

    print("\n4. ANALYSIS RESULTS:")
    print("-" * 60)
    print(json.dumps(result, indent=2, default=str))

    # Test weight suggestions
    print("\n5. Testing weight adjustment suggestions...")
    weight_suggestions = analyzer.suggest_weight_adjustment(result)
    print(json.dumps(weight_suggestions, indent=2))

    print("\n" + "=" * 60)
    print("âœ“ LC_03 ANALYZER TEST COMPLETE")
    print("=" * 60)


if __name__ == "__main__":
    test_lc03_analyzer()
