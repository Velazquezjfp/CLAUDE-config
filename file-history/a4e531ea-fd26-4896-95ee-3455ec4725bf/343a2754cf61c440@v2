"""
Test Case: TC-F-003-03
Requirement: F-003 - Implement batch processing with internal summaries for AI insights
Description: With 250 records (less than batch size), verify single batch processing works correctly
Generated: 2025-10-01T14:59:00Z
"""

import sys
import sqlite3
import time

def test_TC_F_003_03():
    """Verify single batch processing for records less than batch size (250 < 500)"""

    db_path = "/home/javiervel/clients/bosenet/ai-timesheet/inference/docker_files_api_copy2/shared/data/inference_results.db"

    conn = sqlite3.connect(db_path)
    cursor = conn.cursor()

    try:
        # Clear database and insert exactly 250 records
        cursor.execute("DELETE FROM inference_results")
        conn.commit()

        for i in range(250):
            cursor.execute("""
                INSERT INTO inference_results
                (sentence, answer, reason, mode, score, timestamp, batch_id)
                VALUES (?, ?, ?, ?, ?, ?, ?)
            """, (
                f"TC-F-003-03 small batch {i}",
                "accepted", "Test reason", "BERT", 0.90, time.time(), None
            ))

        conn.commit()

        # Verify count
        cursor.execute("SELECT COUNT(*) FROM inference_results")
        count = cursor.fetchone()[0]
        assert count == 250, f"Expected 250 records, got {count}"

        # Test AIInsightsGenerator with small dataset
        # Expected: Should process as single batch (not 3 batches)
        # Should NOT error out or skip processing

        sys.path.insert(0, "/home/javiervel/clients/bosenet/ai-timesheet/inference/docker_files_api_copy2/dashboard/src")
        from ai_insights import AIInsightsGenerator

        generator = AIInsightsGenerator(db_path)

        batch_call_count = 0
        original_batch = generator._process_batch_summary

        def count_batch(batch_data):
            nonlocal batch_call_count
            batch_call_count += 1
            return original_batch(batch_data)

        generator._process_batch_summary = count_batch

        # Clear cache
        cursor.execute("DELETE FROM ai_insights WHERE insight_type = 'pattern_analysis'")
        conn.commit()

        verdict = generator.generate_pattern_analysis()

        # Restore
        generator._process_batch_summary = original_batch

        # Should be called once for single batch
        assert batch_call_count == 1, f"Expected 1 batch, got {batch_call_count}"
        # Verdict should still be generated
        assert len(verdict) > 0, "Verdict should not be empty"

        print(f"âœ“ Single batch processing verified: {batch_call_count} batch for 250 records")
        print("Expected: 1 batch processed (not 3)")

    finally:
        cursor.execute("DELETE FROM inference_results WHERE sentence LIKE 'TC-F-003-03%'")
        conn.commit()
        conn.close()

if __name__ == "__main__":
    try:
        test_TC_F_003_03()
        print("TC-F-003-03: PASSED")
    except AssertionError as e:
        print(f"TC-F-003-03: FAILED - {e}")
    except Exception as e:
        print(f"TC-F-003-03: ERROR - {e}")
